{% extends "layout.html" %}
{% load static %}

{% block title %}Búsqueda de Productos{% endblock %}

{% block content %}
<button class="btn btn-secondary cart-float-btn" onclick="toggleCart()">
  <i class="bi bi-cart"></i> (<span id="cartItemCount">0</span>) | $ <span id="cartTotalFloat">0,00</span> | <span id="cartClientFloat">Sin cliente</span>
</button>

<div class="container-fluid d-flex">
  <!-- Sidebar (Filtros) -->
  <div class="sidebar">
    <div class="filters-container">
      <div class="mb-3">
        <label for="storeFilter" class="form-label">Sucursal</label>
        <select id="storeFilter" class="form-select">
          {% for store in stores %}
            <option value="{{ store }}">{{ store }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="excludeSpecialCategories" checked>
        <label class="form-check-label" for="excludeSpecialCategories">Excluir categorías especiales</label>
      </div>

      <details class="mb-3">
        <summary>Precios</summary>
        <div class="mt-2">
          <label class="form-label">Rango de Precio</label>
          <select id="priceRangeFilter" class="form-select" onchange="actualizarFiltrosPrecio()">
            <option value="">Todos</option>
            <option value="0-250000">0 - 250,000</option>
            <option value="250001-800000">250,001 - 800,000</option>
            <option value="800001-999999999">800,001+</option>
          </select>
          <div class="mt-2 d-flex gap-2">
            <input type="number" id="minPrice" class="form-control" placeholder="Min" min="0" oninput="actualizarFiltrosPrecio()">
            <input type="number" id="maxPrice" class="form-control" placeholder="Max" min="0" oninput="actualizarFiltrosPrecio()">
          </div>
        </div>
      </details>

      <details class="mb-3">
        <summary>Stock</summary>
        <div class="mt-2 d-flex flex-column gap-2">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="signoMas" checked onchange="filterAndPaginate(false)">
            <label class="form-check-label" for="signoMas">Stock positivo</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="signoMenos" checked onchange="filterAndPaginate(false)">
            <label class="form-check-label" for="signoMenos">Stock negativo</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="cero" checked onchange="filterAndPaginate(false)">
            <label class="form-check-label" for="cero">Stock cero</label>
          </div>
        </div>
      </details>

      <details class="mb-3">
        <summary>Categorías</summary>
        <div class="mt-2">
          <label for="categoryFilter" class="form-label">Categoría</label>
          <select id="categoryFilter" class="form-select">
            <option value="">Todos</option>
          </select>

          <label for="coverageGroupFilter" class="form-label mt-2">Grupo de Cobertura</label>
          <select id="coverageGroupFilter" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
      </details>

      <button class="btn btn-secondary w-100 clear-filters-btn" onclick="clearFilters()">Limpiar Filtros</button>
    </div>
  </div>

  <div class="main-content flex-grow-1">
    <!-- Barra de búsqueda y acciones -->
    <div class="search-floating">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="openClientSearchModal()"><i class="bi bi-person"></i></button>
        <button class="btn btn-outline-primary btn-sm" onclick="openScannerModal()"><i class="bi bi-qr-code-scan"></i></button>
        <div class="search-box">
          <i class="bi bi-search search-icon"></i>
          <input type="text" id="search" class="form-control" placeholder="Buscar productos..." />
        </div>
      </div>
    </div>

    <!-- Spinner -->
    <div id="spinner" class="spinner">
      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
    </div>

    <!-- Selector de vista -->
    <div class="view-selector d-flex justify-content-end mb-3">
      <button id="sidebarToggleBtn" class="btn btn-outline-primary"><i class="bi bi-list"></i> Filtros</button>
      <button class="btn btn-outline-primary me-2" id="btnTableView" onclick="cambiarVista('tabla')"><i class="bi bi-table"></i></button>
      <button class="btn btn-outline-primary" id="btnCardView" onclick="cambiarVista('cards')"><i class="bi bi-grid"></i></button>
    </div>

    <!-- Tabla -->
    <div id="tableView" class="table-responsive">
      <table class="table table-striped table-hover" id="productTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">SKU</th>
            <th onclick="sortTable(1)">Categoría</th>
            <th onclick="sortTable(2)">Nombre</th>
            <th onclick="sortTable(3)">Grupo Cobertura</th>
            <th onclick="sortTable(4)">U.M.</th>
            <th onclick="sortTable(5)">Precio IVA</th>
            <th onclick="sortTable(6)">Precio Desc.</th>
            <th onclick="sortTable(7)">Sucursal</th>
            <th>Imagen</th>
            <th>Stock</th>
            <th>Carrito</th>
          </tr>
        </thead>
        <tbody id="productList"></tbody>
      </table>
    </div>

    <!-- Cards -->
    <div id="cardView" class="d-none row row-cols-1 row-cols-md-3 row-cols-lg-5 g-3"></div>

    <!-- Paginación -->
    <div id="pagination" class="d-flex justify-content-center mt-2"></div>
  </div>
</div>

<!-- Modal de imagen -->
<div id="imageModal" class="image-modal">
  <div class="image-modal-content">
    <button class="close-modal" onclick="closeModal()">×</button>
    <img id="modalImage" data-src="" alt="Producto">
  </div>
</div>

<!-- Modal cantidad -->
<div id="quantityModal" class="modal fade quantity-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xxl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title"><i class="bi bi-cart-plus me-2"></i> Agregar al Carrito</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="product-name mb-1" id="quantityModalProductName"></p>
        <p class="price-info mb-3">Precio: <span id="quantityModalProductPrice" class="fw-bold text-success"></span></p>
        <div class="quantity-input-group">
          <label for="quantityInput" class="form-label">Cantidad:</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" onclick="adjustQuantity(-1)"><i class="bi bi-dash"></i></button>
            <input type="number" id="quantityInput" class="form-control text-center" min="1" value="1" onchange="updateTotal()">
            <span class="input-group-text" id="quantityModalUnitMeasure"></span>
            <button class="btn btn-outline-secondary" onclick="adjustQuantity(1)"><i class="bi bi-plus"></i></button>
          </div>
          <p id="quantityModalCajas" class="equivalencia-texto mt-2"></p>
        </div>
        <p class="total-info mt-3">Total: <span id="quantityModalTotal" class="fw-bold text-primary"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="addToCartConfirmed()">Agregar</button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay stock -->
<div id="stockOverlay" class="stock-modal d-none">
  <div class="stock-overlay-content">
    <button class="stock-close-overlay" onclick="cerrarOverlaystock()">×</button>
    <div class="stock-header">
      <h4 id="stockProductoNombre"></h4>
      <p class="stock-subtitle">SKU: <span id="stockProductoCodigo"></span> | Unidad: <span id="stockProductoUnidad"></span></p>
    </div>
    <div class="stock-table-container">
      <table class="table table-striped table-hover stock-table">
        <thead>
          <tr><th>Almacén</th><th>Disponible Venta</th><th>Disponible Entrega</th><th>Comprometido</th></tr>
        </thead>
        <tbody id="stockTabla"></tbody>
        <tfoot>
          <tr><th>Total</th><th id="totalVenta">0,00</th><th id="totalEntrega">0,00</th><th id="totalComprometido">0,00</th></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Inyección segura de datos (Django) -->
{{ stores|json_script:"backend-stores-data" }}
{{ last_store|json_script:"backend-last-store-data" }}

<script>
  const backendStores = JSON.parse(document.getElementById('backend-stores-data').textContent || '[]') || [];
  const lastStore = JSON.parse(document.getElementById('backend-last-store-data').textContent || 'null');

  document.addEventListener("DOMContentLoaded", function () {
    loadProducts(lastStore || 'BA001GC');

    // Sidebar responsive
    if (window.innerWidth < 1200) {
      const sb = document.querySelector('.sidebar');
      if (sb) sb.classList.remove('active');
    }
  });

  // Toggle sidebar
  document.getElementById('sidebarToggleBtn').addEventListener('click', function () {
    document.querySelector('.sidebar').classList.toggle('active');
  });

  // Click afuera cierra sidebar en móvil
  document.addEventListener('click', function (event) {
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    if (window.innerWidth < 1200 && sidebar.classList.contains('active')) {
      if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
        sidebar.classList.remove('active');
      }
    }
  });
</script>
{% endblock %}

{% block extra_scripts %}
  <!-- Google Maps SOLO aquí (evita error de callback en login) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEcZuoclTEV-n1maYIvTQ8C9LkWutbcus&libraries=places&callback=initMap" async defer></script>
  <!-- Tu JS principal -->
  <script src="{% static 'js/scripts.js' %}"></script>
{% endblock %}
